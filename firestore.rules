rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Reglas para anfitriones (efímeros y persistentes)
    match /anfitriones/{anfitrionId} {
      // Permitir leer cualquier anfitrión (para verificación de sesión, login y verificación de email)
      // Esto incluye queries con where()
      allow read: if true;
      
      // Permitir crear anfitriones sin autenticación (alta rápida de anfitriones efímeros)
      // Validaciones básicas
      allow create: if request.auth == null &&
                       // Validar campos requeridos
                       request.resource.data.keys().hasAll(['tipo', 'sesionId', 'alias', 'email', 'emailVerificado', 'tokenVerificacion']) &&
                       // Validar tipos
                       request.resource.data.tipo is string &&
                       request.resource.data.sesionId is string &&
                       request.resource.data.alias is string &&
                       request.resource.data.email is string &&
                       request.resource.data.emailVerificado is bool &&
                       // Validar formato de sesionId
                       request.resource.data.sesionId.matches('ANF-.*') &&
                       // Validar formato de email
                       request.resource.data.email.matches('.*@.*\\..*') &&
                       // Validar que tipo sea "efimero"
                       request.resource.data.tipo == 'efimero';
      
      // Permitir actualizar campos (último acceso, email verificado, eventos creados)
      // Simplificado para debugging - luego agregaremos validaciones
      allow update: if request.auth == null;
      
      // Permitir eliminar anfitriones (solo desde panel de admin con autenticación)
      // ⚠️ En producción, mover eliminaciones a Cloud Functions para mayor seguridad
      allow delete: if request.auth == null;
    }
    
    // Reglas para eventos (si se usan en el futuro)
    match /eventos/{eventoId} {
      allow read: if true;
      allow create, update, delete: if false; // Por ahora, solo lectura
    }
    
    // Reglas para participantes (si se usan en el futuro)
    match /participantes/{participanteId} {
      allow read: if true;
      allow create, update: if false; // Por ahora, solo lectura
      // Permitir eliminar participantes (solo desde panel de admin)
      // ⚠️ En producción, mover eliminaciones a Cloud Functions para mayor seguridad
      allow delete: if request.auth == null;
    }
    
    // Regla por defecto: denegar todo lo demás
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
